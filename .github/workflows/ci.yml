name: "CI Pipeline"

on:
  push:
    branches: ["*"]

jobs:
  build:
    name: "Build & Import Checks"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Go: build extractor ---
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build extractor
        working-directory: ./extractor
        run: |
          go mod tidy
          go build ./...

      # --- Python: install dependencies from combined requirements.txt ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --- Import checks: ensure main modules import cleanly ---
      - name: Validate Python imports
        run: |
          export PYTHONPATH="$PWD"
          python - << 'EOF'
          import transformer.transformer
          import cleaner.cleaner
          print("Transformer and cleaner imported successfully")
          EOF

  docker-validate:
    name: "Docker & Compose Validation"
    runs-on: ubuntu-latest
    needs: build   # run AFTER the build job succeeds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Build key services to ensure Dockerfiles & wiring are valid
      - name: Build key services with docker compose
        run: |
          docker compose -f docker-compose.yaml build extractor
          docker compose -f docker-compose.yaml build transformer
          docker compose -f docker-compose.yaml build cleaner
          docker compose -f docker-compose.yaml build streamlit
          docker compose -f docker-compose.yaml build scheduler

      # Validate docker-compose syntax and service wiring
      - name: Validate docker-compose config
        run: |
          docker compose -f docker-compose.yaml config

  sanity-check:
    name: "Sanity Checks"
    runs-on: ubuntu-latest
    needs: docker-validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Set up Go (for extractor sanity) ---
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # --- Set up Python (for import sanity) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --- Extractor sanity test ---
      - name: Extractor help command
        working-directory: ./extractor
        run: |
          go run . --help || echo "Extractor ran (help may not exist, but main executed)"

      # --- Transformer import sanity test ---
      - name: Transformer import test
        run: |
          export PYTHONPATH="$PWD"
          python - << 'EOF'
          import transformer.transformer
          print("Transformer imported successfully")
          EOF

      # --- Cleaner import sanity test ---
      - name: Cleaner import test
        run: |
          export PYTHONPATH="$PWD"
          python - << 'EOF'
          import cleaner.cleaner
          print("Cleaner imported successfully")
          EOF
